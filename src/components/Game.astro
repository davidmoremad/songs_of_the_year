---
import { songs } from '../data/songs.js';
---


<div class="game-container rounded-lg p-8 shadow-xl bg-primary bg-opacity-20 border-solid border-2 border-primary">
  <div class="header flex justify-between items-center mb-6">
    <div id="songInfo" class="text-2xl font-semibold"></div>
  </div>
  
  <iframe id="audioPlayer" class="w-full mb-6" width="100%" height="400" src="https://www.youtube.com/embed/5qap5aO4i9A" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
  
  <div class="flex justify-between mb-6">
    <button id="showDateButton" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded transition duration-300">Show Date</button>
    <button id="nextSongButton" class="bg-secondary hover:bg-secondary-dark text-white font-bold py-2 px-4 rounded transition duration-300">Next Song</button>
  </div>
  <div id="result" class="text-xl mb-6 text-center"></div>
</div>

<div class="spreadsheet-container bg-primary bg-opacity-20 rounded-lg p-8 mt-12 shadow-xl border-solid border-2 border-primary">
  <div class="scoreboard-header flex justify-between items-center mb-6">
    <h2 class="text-5xl font-semibold">Scoreboard</h2>
    <button id="settingsButton" class="text-3xl bg-transparent hover:bg-primary hover:text-white rounded-full p-2 transition duration-300">⚙️</button>
  </div>
  <div id="playerGuesses" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8"></div>
  <div class="overflow-x-auto">
    <table id="scoreTable" class="w-full">
      <thead>
        <tr class="bg-primary bg-opacity-20">
          <th class="p-3 text-left">Round</th>
          <th class="p-3 text-left">Song</th>
          <th class="p-3 text-left">Player</th>
          <th class="p-3 text-left">Guess</th>
          <th class="p-3 text-left">Points</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be added dynamically -->
      </tbody>
    </table>
  </div>
</div>

<div id="playerSettings" class="modal hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full ">
  <div class="modal-content p-8 rounded-lg shadow-xl max-w-md mx-auto mt-20 bg-primary bg-opacity-20 backdrop-filter backdrop-blur-lg border-solid border-2 border-primary">
    <h2 class="text-2xl font-semibold mb-4">Player Settings</h2>
    <div id="playerList" class="mb-4"></div>
    <div class="flex justify-between">
      <input type="text" id="newPlayerName" placeholder="Nombre del jugador" class="flex-grow mr-2 p-2 mr-2 rounded bg-gray-700 text-white">
      <button id="addPlayer" class="bg-secondary hover:bg-secondary-dark text-white font-bold py-2 px-4 rounded transition duration-300">Add</button>
      <button id="closeSettings" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 ml-2 rounded transition duration-300">Close</button>
    </div>
  </div>
</div>

<script>
  import { songs } from '../data/songs.js';

  let currentSong;
  let currentRound = 1;
  let players = [
    { name: "Sergio", avatar: "🐸", totalPoints: 0 },
    { name: "Javier", avatar: "🐷", totalPoints: 0 },
    { name: "David", avatar: "🐼", totalPoints: 0 }
  ];

  const animalAvatars = ["🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼", "🐨", "🐯", "🦁", "🐮", "🐷", "🐸", "🐙", "🐵", "🐴", "🦄"];

  function loadRandomSong() {
    currentSong = songs[Math.floor(Math.random() * songs.length)];
    document.getElementById('songInfo').innerHTML = `<b>${currentSong.title}</b> <span class="font-thin text-gray-400">by</span> <b>${currentSong.artist}</b>`;
    document.getElementById('audioPlayer').src = currentSong.audio;
    document.getElementById('result').textContent = '';
    document.getElementById('showDateButton').disabled = false;
    updatePlayerGuesses();
  }

  function updatePlayerGuesses() {
    const playerGuessesDiv = document.getElementById('playerGuesses');
    playerGuessesDiv.innerHTML = '';
    players.forEach((player, index) => {
      playerGuessesDiv.innerHTML += `
        <div class="player-guess bg-surface-light p-4 rounded-lg shadow">
          <div class="player-info flex items-center mb-2">
            <span class="player-avatar text-3xl mr-2">${player.avatar}</span>
            <span class="player-name font-semibold">${player.name}</span>
          </div>
          <div class="guess-input flex">
            <input type="number" id="guess-${index}" placeholder="Enter guess" min="1900" max="2023" class="flex-grow mr-2 p-2 rounded bg-gray-700 text-white">
            <button onclick="submitGuess(${index})" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded transition duration-300">Submit</button>
          </div>
        </div>
      `;
    });
  }

  function submitGuess(playerIndex) {
    const guessInput = document.getElementById(`guess-${playerIndex}`);
    const guess = parseInt(guessInput.value);
    if (guess) {
      updateScoreboard(players[playerIndex], guess);
      guessInput.disabled = true;
      if (players.every(p => document.getElementById(`guess-${players.indexOf(p)}`).disabled)) {
        document.getElementById('showDateButton').click();
      }
    } else {
      alert('Please enter a valid year guess.');
    }
  }

  function updateScoreboard(player, guess) {
    const actualYear = currentSong.year;
    const points = Math.max(0, 5 - Math.abs(guess - actualYear));
    player.totalPoints += points;

    const tbody = document.querySelector('#scoreTable tbody');
    const newRow = tbody.insertRow();
    newRow.innerHTML = `
      <td class="p-3">${currentRound}</td>
      <td class="p-3">${currentSong.title}</td>
      <td class="p-3">${player.avatar} ${player.name}</td>
      <td class="p-3">${guess}</td>
      <td class="p-3">${points}</td>
    `;

    if (players.every(p => document.getElementById(`guess-${players.indexOf(p)}`).disabled)) {
      currentRound++;
    }
  }

  document.getElementById('showDateButton').addEventListener('click', () => {
    document.getElementById('result').textContent = `This song was released in ${currentSong.year}.`;
    document.getElementById('showDateButton').disabled = true;
  });

  document.getElementById('nextSongButton').addEventListener('click', () => {
    loadRandomSong();
    players.forEach((_, index) => {
      const guessInput = document.getElementById(`guess-${index}`);
      guessInput.value = '';
      guessInput.disabled = false;
    });
  });

  document.getElementById('settingsButton').addEventListener('click', () => {
    document.getElementById('playerSettings').classList.remove('hidden');
    updatePlayerList();
  });

  document.getElementById('closeSettings').addEventListener('click', () => {
    document.getElementById('playerSettings').classList.add('hidden');
    updatePlayerGuesses();
  });

  document.getElementById('addPlayer').addEventListener('click', () => {
    const newName = document.getElementById('newPlayerName').value;
    const newAvatar = animalAvatars[Math.floor(Math.random() * animalAvatars.length)];
    players.push({ name: newName, avatar: newAvatar, totalPoints: 0 });
    updatePlayerList();
  });

  function updatePlayerList() {
    const playerList = document.getElementById('playerList');
    playerList.innerHTML = '';
    players.forEach((player, index) => {
      playerList.innerHTML += `
        <div class="flex justify-between items-center mb-2">
          <span>${player.avatar} ${player.name}</span>
          <button onclick="removePlayer(${index})" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-sm transition duration-300">Remove</button>
        </div>
      `;
    });
  }

  window.removePlayer = (index) => {
    players.splice(index, 1);
    updatePlayerList();
  };

  window.submitGuess = submitGuess;

  // Load the first song when the page loads
  loadRandomSong();
</script>